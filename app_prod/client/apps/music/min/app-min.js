var Music=(function(){var s=window.parent.$N,h=new s.apps.core.Log("Music","Music"),a={},p=null,z=null,G=null,w=null,t={getTitle:function(O){return O.text;},getIcon:function(O){return O.href;}},e={getText:function(O){if(O&&O.name){return O.name;}if(O&&O.serviceName){return O.serviceName;}return O;},getIcon:function(O){return null;}},l=0,D=0,C=0,K={PORTAL:1,MUSIC_KEY:2},q=K.PORTAL,x={GENRE:0,CHANNELS:1},k=x.GENRE,c={NORMAL:0,SCREEN_SAVER:1,BLACK_SCREEN:2},i=c.NORMAL,u=null,H=null;function n(){w.stop();a.musicGroup.show();a.screensaver.hide();s.app.ClockDisplay.show();s.app.BrandHelper.show(s.app.BrandHelper.MUSIC_BACKGROUND_ID);i=c.NORMAL;}function y(){a.musicGroup.hide();s.app.ClockDisplay.hide();s.app.BrandHelper.hideAll();a.screensaver.show();var P=0,O=16;a.screensaver.animate.genre.setHref(a.musicGroup.tuned.genre.getHref());P=a.screensaver.animate.genre2.getTrueTextLength()+a.screensaver.animate.genre2.getTrueX()+O;a.screensaver.animate.channel.setX(P);a.screensaver.animate.channel.setText(a.musicGroup.tuned.channel.getText());a.screensaver.animate.artist.setText(a.musicGroup.tuned.infoLayer.artist.getText());a.screensaver.animate.song.setText(a.musicGroup.tuned.infoLayer.song.getText());a.screensaver.animate.move(a.screensaver.animate.getTrueX(),a.screensaver.animate.getTrueY());w.start();i=c.SCREEN_SAVER;}function N(){a.musicGroup.hide();a.screensaver.hide();s.app.ClockDisplay.hide();s.app.BrandHelper.hideAll();i=c.BLACK_SCREEN;}function I(O){var P=a.musicGroup.channels.channelList.getData(),Q=3;a.musicGroup.channelArrows.show();if(O>Q){a.musicGroup.channelArrows.upArrow.show();}else{a.musicGroup.channelArrows.upArrow.hide();}if(P.length-1-O>Q){a.musicGroup.channelArrows.downArrow.show();}else{a.musicGroup.channelArrows.downArrow.hide();}}function A(){a.musicGroup.genres.focus.hide();a.musicGroup.channels.focus.show();a.musicGroup.genreArrows.hide();I(D);k=x.CHANNELS;}function j(){a.musicGroup.genres.focus.show();a.musicGroup.channels.focus.hide();a.musicGroup.genreArrows.show();a.musicGroup.channelArrows.hide();k=x.GENRE;}function f(){var P=s.platform.system.Preferences.get(s.app.constants.MUSIC_LAST_PLAYED_CHANNEL),O;if(P){O=P.split(",");l=parseInt(O[0],10)||0;D=parseInt(O[1],10)||0;}}function m(){var O=l+","+D;s.platform.system.Preferences.set(s.app.constants.MUSIC_LAST_PLAYED_CHANNEL,O);}function b(R){var Q=s.app.MusicCategoriesData.getSubCategoriesData(l),P=a.musicGroup.channels.channelList,O=0;P.setData(Q);if(R){D=Math.floor((Q.length-1)/2);}O=D+1;if(O>Q.length){O=Q.length;}P.selectItemAtIndex(O);P.displayData();}function M(O){var R,Q=false,P=a.musicGroup.genres.genreList;if(O&&O.id){R=s.app.MusicCategoriesData.checkGenreIndex(O.id);if(R!==l){l=R;Q=true;}}P.setData(s.app.MusicCategoriesData.getActualGenreData());P.selectItemAtIndex(l+1);P.displayData();b(Q);A();}function g(){var Q=a.musicGroup.genres.genreList.getData(),O=a.musicGroup.channels.channelList.getData(),P=null;if(O.length>0){P=O[D];if(P){C=l;a.musicGroup.tuned.channel.setText(e.getText(P));if(P.uri&&P.uri!==p.getPlayingUri()){p.play(P.uri);}}}if(Q.length>0){a.musicGroup.tuned.genre.setHref(Q[C].href);a.screensaver.animate.genre2.setText(Q[C].text);m();}}function E(O){if(O&&O.artist){a.musicGroup.tuned.infoLayer.artist.setText(O.artist);a.screensaver.animate.artist.setText(a.musicGroup.tuned.infoLayer.artist.getText());}if(O&&O.song){a.musicGroup.tuned.infoLayer.song.setText(O.song);a.screensaver.animate.song.setText(a.musicGroup.tuned.infoLayer.song.getText());}if(O&&O.album){a.musicGroup.tuned.infoLayer.albumtitle.setText(O.album);}}function o(){a.musicGroup.title.setText(Music.getString("musicTitle"));a.musicGroup.buttonIcons.redButton.setText(Music.getString("screenSaver"));a.musicGroup.buttonIcons.greenButton.setText(Music.getString("blackScreen"));a.musicGroup.buttonIcons.okButton.setText(Music.getString("select"));a.musicGroup.buttonIcons.exitButton.setText(Music.getString("exit"));a.musicGroup.tuned.title.setText(Music.getString("tunedTitle"));a.musicGroup.tuned.infoLayer.artistTitle.setText(Music.getString("artistTitle"));a.musicGroup.tuned.infoLayer.songTitle.setText(Music.getString("songTitle"));a.musicGroup.tuned.infoLayer.albumtitleTitle.setText(Music.getString("albumtitleTitle"));a.screensaver.animate.artistTitle.setText(Music.getString("artistTitle"));a.screensaver.animate.songTitle.setText(Music.getString("songTitle"));a.musicGroup.tuned.waitingLayer.waitingText.setText(Music.getString("waitingText"));}function d(O){l=s.app.MusicCategoriesData.checkGenreIndex(O.id);b(true);}function r(P){var O=a.musicGroup.channels.channelList.getSelectedItemIndex()-1;I(O);}function L(){a.musicGroup.buttonIcons.redButton._label.setCssClass("summaryDescription");a.musicGroup.buttonIcons.greenButton._label.setCssClass("summaryDescription");a.musicGroup.buttonIcons.okButton._label.setCssClass("summaryDescription");a.musicGroup.buttonIcons.exitButton._label.setCssClass("summaryDescription");a.musicGroup.buttonIcons.initialise();}function J(){s.app.MusicCategoriesData.refreshRadioChannels();D=a.musicGroup.channels.channelList.getSelectedItemIndex()-1;b(false);}function F(O){if(O){a.musicGroup.tuned.infoLayer.hide();a.musicGroup.tuned.infoLayer.artist.setText("");a.musicGroup.tuned.infoLayer.song.setText("");a.musicGroup.tuned.infoLayer.albumtitle.setText("");a.musicGroup.tuned.waitingLayer.show();a.musicGroup.tuned.waitingLayer.indicatorImage.show();}else{a.musicGroup.tuned.infoLayer.show();a.musicGroup.tuned.waitingLayer.indicatorImage.hide();a.musicGroup.tuned.waitingLayer.hide();}}function B(O){var P=true;if(O&&O.activeMode&&O.activeMode==="musicKey"){s.app.fullScreenPlayer.stopPlayout(P);}}function v(){if(u){clearTimeout(u);u=null;}}return{load:function(){s.gui.ResolutionManager.initialiseContext(document);s.apps.core.Language.importLanguageBundleForObject(Music,Music.init,"apps/music/common/","LanguageBundle.js",null,window);},init:function(){s.gui.FrameworkCore.loadGUIFromXML("apps/music/view/music.xml",document.getElementById("content"),a,window);a.musicGroup.genres.genreList.setDataMapper(t);a.musicGroup.genres.genreList.setItemHighlightedCallback(d);a.musicGroup.genres.genreList.init();a.musicGroup.channels.channelList.setDataMapper(e);a.musicGroup.channels.channelList.setItemHighlightedCallback(r);a.musicGroup.channels.channelList.init();L();p=new s.app.players.RadioPlayer();w=new ScreenSaver(a.screensaver.animate,this);p.setWaitingCallback(F);s.platform.btv.EPG.registerRefreshCallback(J,this);s.apps.core.ContextManager.initialisationComplete(Music);},activate:function(R){var Q=(R&&R.activeMode)?R.activeMode:null,P=(R&&R.currentService)?R.currentService:R,O=(R&&R.previousService)?R.previousService:null;B(R);v();q=K.MUSIC_KEY;if(R&&R.activeMode&&R.activeMode.toUpperCase()==="PORTAL"){q=K.PORTAL;}if(i!==c.NORMAL){n();}f();M(P);p.setActiveMode(Q);p.setPreviousService(O);this.focus();z=true;},passivate:function(){if(z){z=false;s.app.ClockDisplay.hide();s.app.BrandHelper.hideAll();this.defocus();}},focus:function(){G=true;o();p.activate();p.setMetaDataFoundCallback(E);g();s.app.ClockDisplay.show();s.app.BrandHelper.show(s.app.BrandHelper.MUSIC_BACKGROUND_ID);s.common.helper.FrontPanelManager.setFrontPanelDisplay(s.app.constants.FRONTPANEL_DISPLAY_MODES.MUSIC);},defocus:function(){if(G){G=false;p.passivate();p.setMetaDataFoundCallback(null);s.common.helper.FrontPanelManager.setFrontPanelDisplay(s.app.constants.FRONTPANEL_DISPLAY_MODES.DEFAULT);}},preview:function(){},dismissPreview:function(){},toString:function(){return"MUSIC";},keyHandler:function(P,O){var Q=s.apps.core.KeyInterceptor.getKeyMap(),R=false;s.app.MemoryUtil.setOrUpdateGarbageCollectTimeoutAndInterval();if(O){switch(P){case Q.KEY_GUIDE:return true;}}if(P===Q.KEY_POWER){p.stop();return false;}if(i!==c.NORMAL&&!s.app.GeneralUtil.isKeyReleaseEvent(P)){n();return true;}switch(P){case Q.KEY_EXIT:s.app.ClockDisplay.hide();R=false;break;case Q.KEY_RED:y();R=true;break;case Q.KEY_GREEN:N();R=true;break;case Q.KEY_LEFT:if(k===x.CHANNELS){j();}else{if(k===x.GENRE){s.app.DialogueHelper.displayExitAppDialog(s.app.ContextHelper.closeContext);}}R=true;break;case Q.KEY_OK:if(C!==a.musicGroup.genres.genreList.getSelectedItemIndex()-1||D!==a.musicGroup.channels.channelList.getSelectedItemIndex()-1){D=a.musicGroup.channels.channelList.getSelectedItemIndex()-1;g();}if(k===x.GENRE){A();}R=true;break;case Q.KEY_RIGHT:if(k===x.GENRE){A();}else{if(k===x.CHANNELS&&D!==a.musicGroup.channels.channelList.getSelectedItemIndex()-1){D=a.musicGroup.channels.channelList.getSelectedItemIndex()-1;g();}}R=true;break;}if(!R){if(k===x.CHANNELS){R=a.musicGroup.channels.channelList.keyHandler(P);}else{R=a.musicGroup.genres.genreList.keyHandler(P);}}return R;}};}());var $N=window.parent.$N;$N.app=$N.app||{};$N.app.players=$N.app.players||{};(function(a){function b(){this._log=new a.apps.core.Log("Music","RadioPlayer");var c=this;this._INITIAL_INTERVAL=200;this._REVIEW_INTERVAL=3000;this.contentStartFailedReason={LACK_OF_RESOURCES:-2,CONFLICT:-3};this._checkMetaDataInterval=this._INITIAL_INTERVAL;this._metaDataFoundCallback=null;this._mataDataUrl="";this._checkMetaDataTimer=null;this._httpRequest=null;this._playingUri="";this._waitingCallback=null;this._channelToBack=null;this._failureCallback=function(d){if(d.contentStartFailedInfo&&d.contentStartFailedInfo.sourceUri&&d.contentStartFailedInfo.sourceUri===c._playingUri){c.refreshWaitingLayer(false);}if(d.contentStartFailedInfo.reason===c.contentStartFailedReason.LACK_OF_RESOURCES||d.contentStartFailedInfo.reason===c.contentStartFailedReason.CONFLICT){c.showConflictDialog();}};this._previousService=null;this._activeMode=null;}b.prototype.showConflictDialog=function(){var d=this,c=a.app.PVRUtil.getActiveAndSuspendedRecordings();a.app.Conflicts.showConflictDialog(null,c,a.app.PVRUtil.WATCH_CONFLICT,function(){d.play(d._playingUri);},function(){a.app.ContextHelper.exitContext();});};b.prototype.refreshWaitingLayer=function(c){if(this._waitingCallback){this._waitingCallback(c);}};b.prototype.setChannelToBack=function(c){this._channelToBack=c;};b.prototype.setPreviousService=function(c){this._previousService=c;};b.prototype.setActiveMode=function(c){this._activeMode=c;};b.prototype.activate=function(){var c=this;a.app.fullScreenPlayer.unregisterPlayerConnectFailedListener(a.app.fullScreenPlayer._playerConnectFailedListener);a.app.fullScreenPlayer.registerPlayerConnectFailedListener(this._failureCallback);a.app.fullScreenPlayer.tracks.setNewAudioTrackFoundCallback(function(){c._newOTVModuleFoundCallback();});a.app.fullScreenPlayer.tuner.hideVideo();};b.prototype.passivate=function(){a.app.fullScreenPlayer.tuner.showVideo();this.stop();a.app.fullScreenPlayer.tracks.setNewAudioTrackFoundCallback(null);a.app.fullScreenPlayer.registerPlayerConnectFailedListener(a.app.fullScreenPlayer._playerConnectFailedListener);a.app.fullScreenPlayer.unregisterPlayerConnectFailedListener(this._failureCallback);this._restoreVideoChannel();};b.prototype.play=function(c){this._mataDataUrl="";if(this._checkMetaDataTimer){clearTimeout(this._checkMetaDataTimer);this._checkMetaDataTimer=null;}this.refreshWaitingLayer(true);a.app.fullScreenPlayer.playStream(c);this._playingUri=c;};b.prototype.stop=function(){this._mataDataUrl="";this._httpRequest=null;if(this._checkMetaDataTimer){clearTimeout(this._checkMetaDataTimer);this._checkMetaDataTimer=null;}if(this._httpRequest){this._httpRequest.abort();this._httpRequest=null;}this._playingUri="";a.app.fullScreenPlayer.stopPlayout(true);};b.prototype.setMetaDataFoundCallback=function(c){this._metaDataFoundCallback=c;};b.prototype.setWaitingCallback=function(c){this._waitingCallback=c;};b.prototype.getPlayingUri=function(){return this._playingUri;};b.prototype._getMetaData=function(){var c=this;if(this._checkMetaDataTimer){clearTimeout(this._checkMetaDataTimer);this._checkMetaDataTimer=null;}this._checkMetaDataTimer=null;this._httpRequest=new XMLHttpRequest();this._httpRequest.open("GET",this._mataDataUrl,true);this._httpRequest.onreadystatechange=function(){var e=[],d={};if(c._httpRequest.readyState===4){if(c._httpRequest.responseText.length>0){if(c._metaDataFoundCallback){e=c._httpRequest.responseText.split(/\r\n/g);d.artist=e[0];d.song=e[1];d.album=e[2];d.year=e[3];c._metaDataFoundCallback(d);if(c._checkMetaDataInterval===c._INITIAL_INTERVAL){c._checkMetaDataInterval=c._REVIEW_INTERVAL;c.refreshWaitingLayer(false);}}}c._checkMetaDataTimer=setTimeout(function(){c._getMetaData();},c._checkMetaDataInterval);c._httpRequest=null;}};this._httpRequest.send();};b.prototype._newOTVModuleFoundCallback=function(){var d=a.app.fullScreenPlayer.tracks.getDataTracks(),f=a.app.fullScreenPlayer.tuner.getPlayer(),j=null,c,h,e,k=f.connId,g=this;for(e=0;e<d.length;e+=1){j=d[e];if(j.format===f.STREAM_FORMAT_DATA_OTV_MODULE){c=j.pid;c=j.pid;if(j.idataOtvModule){h=j.idataOtvModule.tableId;}else{}}}if((c!==undefined)&&(h!==undefined)){this._mataDataUrl="/mnt/otv_carousel/OTV/"+k+"/"+c+"/"+h+"/module_1";this._checkMetaDataInterval=this._INITIAL_INTERVAL;setTimeout(function(){g._getMetaData();},1);}};b.prototype._restoreVideoChannel=function(){var f={casId:null},d={url:null,isLive:true,isMusic:null,context:null,serviceId:null},c=null,e=null;if(this._channelToBack!==null){e=this._channelToBack;}else{if(a.app.epgUtil.getChannelFromPrefs()){e=a.app.epgUtil.getChannelFromPrefs();}}if(e){c=a.platform.btv.EPG.getChannelByServiceId(e);if(c&&c.logicalChannelNum){if(this._channelToBack===null){if(!this._activeMode&&this._previousService){a.app.ContextHelper.openContext("ZAPPER",{activationContext:this._previousService});}else{d.url=c.uri;d.isMusic=a.platform.btv.EPG.isRadioChannel(c);d.serviceId=c.serviceId;f.casId=(c.conditionalAccessIDs)?c.conditionalAccessIDs[0]:null;a.app.fullScreenPlayer.requestPlayout(d,true,this._playoutCasId);}}else{if(a.apps.core.ContextManager.getDefaultContext().getId()==="ZAPPER"){a.apps.core.ContextManager.getDefaultContext().getController().tuneWithoutBannerUpdate(c);}}}}this._channelToBack=null;};a.app.players.RadioPlayer=b;}($N));var $N=window.parent.$N;function ScreenSaver(b,a){this._log=new $N.apps.core.Log("Music","ScreenSaver");this._guiObject=b;this._parent=a;this._tmr=null;}ScreenSaver.prototype.start=function(){var h,g,m,l,f,c,a,b=90,i=1000,j=60,d=720,k=null,e=this;if(this._guiObject===null){return;}k=function(){if(f>30){m=Math.floor(Math.random()*(i-b+1)+b);l=Math.floor(Math.random()*(d-j+1)+j);f=0;}f+=1;c+=(m-h)/40000;a+=(l-g)/40000;var n=Math.sqrt(c*c+a*a);if(n>2.4){c=2.4*c/n;a=2.4*a/n;}h+=c;g+=a;e._guiObject.move(Math.floor(h),Math.floor(g));};this.stop();this._tmr=setInterval(k,16,this);h=Math.floor(Math.random()*(i-b+1)+b);g=Math.floor(Math.random()*(d-j+1)+j);m=Math.floor(Math.random()*(i-b+1)+b);l=Math.floor(Math.random()*(d-j+1)+j);f=0;c=0;a=0;this._guiObject.move(h,g);k();};ScreenSaver.prototype.stop=function(){if(this._tmr){clearInterval(this._tmr);this._tmr=null;}};